<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>スキルマップ 一括回答</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --bg: #fafafa;
      --card-bg: #fff;
      --border: #ddd;
      --text: #111;
      --muted: #666;
      --primary: #06c755;
      --danger: #b00020;
      --radius: 12px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      margin: 16px;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 920px;
      margin: 0 auto;
    }

    h2 { margin: 0 0 6px; }
    .meta {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
    }

    .name {
      font-weight: 700;
      margin-bottom: 10px;
      line-height: 1.25;
      word-break: break-word;
    }

    /* ✅ ラジオ */
    .radio-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .radio{
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      line-height: 1.25;
      padding: 6px 8px;
      border-radius: 10px;
    }

    .radio input{
      margin-top: 2px;
      transform: scale(1.1);
      flex: 0 0 auto;
    }

    .radio:has(input:checked) {
      outline: 2px solid rgba(6, 199, 85, 0.25);
      background: rgba(6, 199, 85, 0.06);
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      margin-top: 16px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .error {
      color: var(--danger);
      white-space: pre-wrap;
      margin-top: 12px;
    }

    /* ✅ 追加：空表示 */
    .empty {
      background: var(--card-bg);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 14px;
      color: var(--muted);
      text-align: center;
    }

    @media (min-width: 640px) {
      body { margin: 20px; }
      .card { padding: 14px; }
      .radio { font-size: 15px; }
      button { font-size: 16px; }
    }

    @media (min-width: 960px) {
      body { margin: 24px; }
      .card { padding: 16px; }
    }

    @media (max-width: 360px) {
      body { margin: 12px; }
      .radio { padding: 6px; }
      button { padding: 11px; }
    }

    /* =========================
     * ✅ 追加：ローディング & トースト
     * ========================= */

    /* ✅ ローディングオーバーレイ */
    .loading{
      position: fixed;
      inset: 0;
      display: none;              /* ←普段は非表示 */
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      background: rgba(250,250,250,0.85);
      backdrop-filter: blur(2px);
      z-index: 9999;
    }

    .loading.is-active{
      display: flex;
    }

    .spinner{
      width: 44px;
      height: 44px;
      border: 4px solid rgba(0,0,0,0.12);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin{
      to { transform: rotate(360deg); }
    }

    .loading__text{
      font-size: 14px;
      color: var(--muted);
    }

    /* ✅ トースト（送信しました等） */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events: none;
      background: rgba(17,17,17,0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      max-width: min(92vw, 520px);
      text-align: center;
      z-index: 10000;
      transition: opacity 160ms ease, transform 160ms ease;
    }

    .toast.is-show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>スキルマップ 一括回答</h2>
    <div class="meta" id="meta"></div>

    <div id="list"></div>

    <button id="submit" disabled>送信</button>
    <div class="error" id="error"></div>

    <!-- ✅ ローディング（通信中） -->
    <div id="loading" class="loading" aria-hidden="true">
      <div class="spinner" aria-label="loading"></div>
      <div class="loading__text" id="loadingText">通信中...</div>
    </div>

    <!-- ✅ 送信完了メッセージ（トースト） -->
    <div id="toast" class="toast" aria-hidden="true"></div>

    <!-- 送信用（CORS回避） -->
    <iframe name="hidden_iframe" style="display:none;"></iframe>
    <form id="submitForm" target="hidden_iframe" method="POST">
      <input type="hidden" name="path" value="liff/submit">
      <input type="hidden" name="payload" id="payloadInput">
    </form>
  </div>

<script>
/* ==============================
 * ★ 設定（ここだけ後で差し替え）
 * ============================== */
const LIFF_ID  = "2008741403-IveKN81E";
const GAS_EXEC = "https://script.google.com/macros/s/AKfycbwo14leyLlfdEXFIgQ6XLccC7fwDG0ywgv2zPQ22fo6Cnn-fwNWnmoHMOJTN_jDkdhogg/exec";
/* ============================== */

const metaEl   = document.getElementById("meta");
const listEl   = document.getElementById("list");
const errorEl  = document.getElementById("error");
const submitEl = document.getElementById("submit");

/* ✅ 追加：ローディング・トースト */
const loadingEl = document.getElementById("loading");
const loadingTextEl = document.getElementById("loadingText");
const toastEl = document.getElementById("toast");

let items = [];
let userId = "";

/* ---------- utils ---------- */
function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, c =>
    ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;" }[c])
  );
}

function stripLeading_(s, ch) {
  return (s && s.startsWith(ch)) ? s.slice(1) : s;
}

function safeDecode_(s) {
  try { return decodeURIComponent(s); } catch { return s; }
}

/* ✅ ローディング表示制御 */
function setLoading(on, text = "通信中...") {
  if (on) {
    loadingTextEl.textContent = text;
    loadingEl.classList.add("is-active");
    loadingEl.setAttribute("aria-hidden", "false");
  } else {
    loadingEl.classList.remove("is-active");
    loadingEl.setAttribute("aria-hidden", "true");
  }
}

/* ✅ トースト表示 */
function showToast(msg, ms = 1800) {
  toastEl.textContent = msg;
  toastEl.classList.add("is-show");
  toastEl.setAttribute("aria-hidden", "false");
  setTimeout(() => {
    toastEl.classList.remove("is-show");
    toastEl.setAttribute("aria-hidden", "true");
  }, ms);
}

/**
 * ✅ req を URL から復元する（通常クエリ + liff.state 対応）
 */
function getReqIdFromUrl() {
  const href = window.location.href;
  const url = new URL(href);

  const direct = url.searchParams.get("req");
  if (direct) return direct;

  const stateRaw = url.searchParams.get("liff.state");
  if (!stateRaw) return null;

  const candidates = [stateRaw, safeDecode_(stateRaw), safeDecode_(safeDecode_(stateRaw))];

  for (const s of candidates) {
    if (!s) continue;

    let sp = new URLSearchParams(stripLeading_(s, "?"));
    let req = sp.get("req");
    if (req) return req;

    try {
      const asUrl = new URL(s, window.location.origin);
      req = asUrl.searchParams.get("req");
      if (req) return req;
    } catch (_) {}

    const q = s.indexOf("?");
    if (q >= 0) {
      sp = new URLSearchParams(s.slice(q + 1));
      req = sp.get("req");
      if (req) return req;
    }
  }
  return null;
}

/* ---------- JSONP（一覧取得） ---------- */
function jsonpGet_(reqId, userId) {
  return new Promise((resolve, reject) => {
    const cb = "__cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    window[cb] = (data) => {
      delete window[cb];
      script.remove();
      resolve(data);
    };

    const script = document.createElement("script");
    script.onerror = () => {
      delete window[cb];
      script.remove();
      reject(new Error("JSONP failed"));
    };

    const url =
      GAS_EXEC +
      "?path=liff/get" +
      "&reqId=" + encodeURIComponent(reqId) +
      "&userId=" + encodeURIComponent(userId || "") +
      "&callback=" + encodeURIComponent(cb);

    script.src = url;
    document.head.appendChild(script);
  });
}

/* ---------- render（ラジオ） ---------- */
function radio(idx, current, value, label) {
  return `
    <label class="radio">
      <input
        type="radio"
        name="status-${idx}"
        data-idx="${idx}"
        data-key="status"
        value="${value}"
        ${current === value ? "checked" : ""}
      >
      <span>${label}</span>
    </label>
  `;
}

function render() {
  // ✅ データ無しの表示
  if (!items || items.length === 0) {
    listEl.innerHTML = `<div class="empty">未報告のデータはありません</div>`;
    submitEl.disabled = true;
    return;
  }

  listEl.innerHTML = items.map((it, idx) => `
    <div class="card">
      <div class="name">${escapeHtml(it.personName)}</div>

      <div class="radio-group" role="radiogroup" aria-label="ステータス選択">
        ${radio(idx, it.status, "DONE_INTERVIEW", "未完了（面談実施済）")}
        ${radio(idx, it.status, "NOT_DONE", "未完了（面談未実施）")}
        ${radio(idx, it.status, "NO_HEARING", "聴取未対応")}
        ${radio(idx, it.status, "NO_ACTION", "面談対応なし（休職・退職等）")}
        ${radio(idx, it.status, "COMPLETED", "完了")}
      </div>
    </div>
  `).join("");

  listEl.onchange = (e) => {
    const el = e.target;
    if (!el.matches('input[type="radio"][data-key="status"]')) return;

    const idx = Number(el.dataset.idx);
    items[idx].status = el.value;
  };

  submitEl.disabled = false;
}

/* ---------- main ---------- */
async function main() {
  const reqId = getReqIdFromUrl();
  if (!reqId) {
    errorEl.textContent = "URLに ?req=REQ-XXXX が必要です（リダイレクトで消えた場合は liff.state から復元しますが、復元できませんでした）";
    return;
  }

  setLoading(true, "LIFF 初期化中...");

  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    setLoading(false);
    liff.login({ redirectUri: window.location.href });
    return;
  }

  const profile = await liff.getProfile();
  userId = profile.userId;

  metaEl.textContent = `依頼ID: ${reqId}`;

  try {
    setLoading(true, "一覧を取得中...");
    const res = await jsonpGet_(reqId, userId);
    if (res.ok === false) throw new Error(res.error || "error");

    items = (res.items || []).map(x => ({
      personId: x.personId,
      personName: x.personName,
      status: x.status || "COMPLETED",
    }));

    render();
  } catch (err) {
    errorEl.textContent = String(err);
    // 取得失敗は “未報告なし” ではなくエラーなので、renderは呼ばない
  } finally {
    setLoading(false);
  }

  submitEl.addEventListener("click", () => {
    submitEl.disabled = true;
    errorEl.textContent = "";

    try {
      setLoading(true, "送信中...");

      const payload = { reqId, userId, items };
      document.getElementById("submitForm").action = GAS_EXEC;
      document.getElementById("payloadInput").value = JSON.stringify(payload);
      document.getElementById("submitForm").submit();

      // ✅ 送信メッセージ表示
      showToast("送信しました");

      // ✅ LIFF内なら少し見せてから閉じる
      setTimeout(() => {
        setLoading(false);
        if (liff.isInClient()) liff.closeWindow();
        else metaEl.textContent = "送信しました";
      }, 900);

    } catch (err) {
      setLoading(false);
      errorEl.textContent = String(err);
      submitEl.disabled = false;
    }
  });
}

main().catch(err => {
  setLoading(false);
  errorEl.textContent = String(err);
});
</script>
</body>
</html>
